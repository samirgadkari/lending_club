---
title: "Lending club"
author: "Samir Gadkari"
date: "3/24/2021"
output: html_document
---

```{r include=FALSE}
library(tidyverse)
library(readr)
```

## 1.1 Read in data
Since the accepted/rejected files are large, grep it and save all "credit_card" rejections to another file. This will make it faster (and possible) to load it in memory during the read_csv call.

```{bash}
FILE=$DATASETS/financial_datasets/all_lending_club_loan_data/accepted_credit_card_2007_to_2018Q4_2.csv

if [ ! -f "$FILE" ]; then
  grep "credit_card" $DATASETS/financial_datasets/all_lending_club_loan_data/accepted_2007_to_2018Q4_2.csv >> $DATASETS/financial_datasets/all_lending_club_loan_data/accepted_credit_card_2007_to_2018Q4_2.csv
fi

FILE=$DATASETS/financial_datasets/all_lending_club_loan_data/rejected_credit_card_2007_to_2018Q4_2.csv

if [ ! -f "$FILE" ]; then
  grep "credit_card" $DATASETS/financial_datasets/all_lending_club_loan_data/rejected_2007_to_2018Q4_2.csv >> $DATASETS/financial_datasets/all_lending_club_loan_data/rejected_credit_card_2007_to_2018Q4_2.csv
fi
```

```{r}
data_path <- paste0(Sys.getenv("DATASETS"), "/financial_datasets",
                   "/all_lending_club_loan_data")

accepted_cc <- read_csv(
  paste0(data_path, "/accepted_credit_card_2007_to_2018Q4_2.csv"),
  col_types = cols(desc = col_character(),
                   revol_bal_joint = col_double(),
                   sec_app_fico_range_low = col_double(), 
                   sec_app_fico_range_high = col_double(),
                   sec_app_earliest_cr_line =
                     col_double(),    
                   sec_app_inq_last_6mths = col_double(),
                   sec_app_mort_acc = col_double(),
                   sec_app_open_acc = col_double(),
                   sec_app_revol_util = col_double(),
                   sec_app_open_act_il = col_double(),    
                   sec_app_num_rev_accts = col_double(),
                   sec_app_earliest_cr_line = 
                     col_skip(),
                   sec_app_chargeoff_within_12_mths =
                     col_double(),
                   sec_app_collections_12_mths_ex_med =
                     col_double(),
                   sec_app_mths_since_last_major_derog =
                     col_double()
                  ),
  progress = show_progress())

head(accepted_cc)
nrow(accepted_cc)
```
```{r}
nrow(accepted_cc[accepted_cc$purpose == "credit_card", ])
```

Great !! Now we have half a million row values to work with (and that's just for the accepted credit applications).

## 1.2 Select columns and rows that are not full of NAs

Let's see which columns are not full of NAs.
```{r}
(selected_cols <- accepted_cc %>%
  select(which(colMeans(is.na(.)) < 0.02)) %>%
  names())
```
Now we have the columns where the number of NAs are less than 2%. We should do this, since this is lending club data, and columns which are expected to be useful will not have significant NAs.

Let's select these columns, and remove any rows that have NA values in it. This way, we won't have to deal with any missing values. If our model is bad, we can always interpolate the missing values.

```{r}
accepted_cc <- na.omit(accepted_cc[ , selected_cols])
head(accepted_cc)
```

Now we have a large number of rows, enough to work with.

```{r}
print(paste(names(accepted_cc), collapse = ",  "))
```
## 1.3 List unique values in character columns

```{r}
unique_values <- function(ref) {
  paste(unique(ref), collapse = ",   ")
}

unique_char_col_vals <- function(df_name, df) {
  writeLines(
    stringr::str_glue("{df_name}: ------------------------------->>>>>"))
  
  result <- as.list(df %>%
        select(df %>%
                 select_if(is.character) %>%
                 select(!contains("date", ignore.case = TRUE)) %>%
                 summarise(across(everything(), n_distinct)) %>%
                 select(where(~.x[[1]] < 40)) %>%
                 names()) %>%
        summarise(across(everything(), unique_values)))

  print(result)
  
  writeLines(
    stringr::str_glue("<<<<<--------------------------- :{df_name}"))
}

unique_char_col_vals("accepted_cc", accepted_cc)
```
## 1.4 Understanding the id column

```{r}
n_occur <- data.frame(table(as.integer(accepted_cc$id)))
n_occur[n_occur$Freq > 1, ]
remove(n_occur)
```


Each id value is unique, and none of them are member IDs. This means each line is for a separate loan.

```{r}
print(paste(names(accepted_cc), collapse = ",  "))
```

## 1.5 Date columns

### 1.5.1 Convert date character columns to POSIXct format

Convert all date columns to POSIXct for ease of use later. There is no day specified, and POSIXct requires it. We will add the first day of the month to each date.

```{r}
to_day_month_year <- function(month_year) {
  as.POSIXct(strptime(paste0("01-", month_year), 
                      "%d-%b-%Y"))
}

accepted_cc <- accepted_cc %>%
  mutate(
    issue_date = to_day_month_year(issue_d), .after = issue_d
  ) %>%
  mutate(
    earliest_cr_line = to_day_month_year(earliest_cr_line),
    last_pymnt_d = to_day_month_year(last_pymnt_d),
    last_credit_pull_d = 
      to_day_month_year(last_credit_pull_d)
  ) %>%
  select(-issue_d)

min(accepted_cc[["issue_date"]])
max(accepted_cc[["issue_date"]])
```

There are accounts from `min(accepted_cc[["issue_date"]]` through `min(accepted_cc[["issue_date"]]`.

### 1.5.2 Distribution of date columns

Let's look at the distribution of the dates:

```{r}
accepted_cc %>%
  ggplot(aes(x = issue_date)) +
  geom_histogram(bins = 30)

accepted_cc %>%
  ggplot(aes(x = earliest_cr_line)) +
  geom_histogram(bins = 30)
```

## 1.6 Numerical columns

```{r}
table(accepted_cc$pub_rec)              # public records count?
table(accepted_cc$pub_rec_bankruptcies) # public record bankruptcies count
```

> We may need these columns. There are many bankruptcies which we can use
> to filter out bad applicants - especially when there are more than one.

```{r}
sum(!near(accepted_cc$funded_amnt,
          accepted_cc$funded_amnt_inv, tol = 700.0))
head(accepted_cc[!near(accepted_cc$funded_amnt,
                       accepted_cc$funded_amnt_inv, tol = 700.0), 
                 c("funded_amnt", "funded_amnt_inv")])
sum(!near(accepted_cc$loan_amnt,
          accepted_cc$funded_amnt, tol = 700.0))
head(accepted_cc[!near(accepted_cc$loan_amnt,
                       accepted_cc$funded_amnt, tol = 700.0),
                 c("loan_amnt", "funded_amnt")])
```

> The funded amounts, and the loan amounts are close to each other for almost 
> all of the data.
> Since there is very little information in these three columns together,
> we can remove two of them. Let's keep the funded amount column.

```{r}
accepted_cc <- accepted_cc %>% 
  select(-c(loan_amnt, funded_amnt_inv))
```


```{r}
sum(!near(accepted_cc$total_pymnt, 
          accepted_cc$total_pymnt_inv, tol = 700.0))
head(accepted_cc[!near(accepted_cc$total_pymnt, 
          accepted_cc$total_pymnt_inv, tol = 700.0), 
          c("total_pymnt", "total_pymnt_inv")])
```

> The payment amounts are close to each other for almost all of the data.
> Since there is very little information in these two columns together,
> we can remove one of them.

```{r}
accepted_cc <- accepted_cc %>%
  select(-total_pymnt_inv)
```

```{r}
sum(!near(accepted_cc$out_prncp,
          accepted_cc$out_prncp_inv, tol = 700.0))
```

> The two columns (out_prncp, out_prncp_inv) are almost the same.
> We will remove one of them

```{r}
accepted_cc <- accepted_cc %>%
  select(-out_prncp_inv)

accepted_cc %>%
  select(funded_amnt, term, int_rate, installment,
         revol_bal, revol_util, total_pymnt, total_rec_prncp, out_prncp, total_rec_int,
         last_pymnt_amnt, last_pymnt_d, bc_open_to_buy, bc_util, mths_since_recent_bc,
         num_bc_sats, num_sats, percent_bc_gt_75, total_bal_ex_mort,
         total_bc_limit)
```


```{r}
unique(accepted_cc$policy_code)
```

> Only one policy code - so remove the column.
> 
> The url column is not useful - it's been a while, and none of the urls work.
> Remove the column.
> The purpose and title columns are also not useful. The stated purpose is
> for credit card refinancing/payments, but there is no guarantee that is what
> the loan is going to be used for.

```{r}
accepted_cc <- accepted_cc %>%
  select(-c(policy_code, url, purpose, title))
```

```{r}
head(accepted_cc[accepted_cc$total_bc_limit, ])
```

```{r}
table(accepted_cc$tax_liens)
table(accepted_cc$debt_settlement_flag)
table(accepted_cc$hardship_flag)
```

> There are very few hardship cases - remove them.

```{r}
table(accepted_cc$hardship_flag)
accepted_cc <- accepted_cc %>%
  filter(hardship_flag == "N")

table(accepted_cc$hardship_flag)
accepted_cc <- accepted_cc %>%
  select(-c(hardship_flag))
```

```{r}
table(accepted_cc$inq_last_6mths)
```

```{r}
table(accepted_cc$delinq_2yrs)
```
```{r}
table(accepted_cc$pymnt_plan)
```

> There are only 96 payment plans set up. We can ignore this column,
> or better yet, remove these rows, as they will get averaged out.

```{r}
if ("y" %in% accepted_cc$pymnt_plan) {
  accepted_cc <- accepted_cc %>%
    filter(pymnt_plan == "y")
}

table(accepted_cc$pymnt_plan)

accepted_cc <- accepted_cc %>%
  select(-c(pymnt_plan))
```


```{r}
table(accepted_cc$verification_status)
```

```{r}
table(accepted_cc$home_ownership)
```

> We can remove the ANY, NONE, OTHER rows.

```{r}
accepted_cc <- accepted_cc %>%
  filter(home_ownership %in% c("MORTGAGE", "OWN", "RENT"))
table(accepted_cc$home_ownership)
```

```{r}
table(accepted_cc$term)
```
```{r}
table(accepted_cc$mort_acc)
```

```{r}
table(accepted_cc$chargeoff_within_12_mths)
```

```{r}
head(accepted_cc$installment)
```

```{r}
table(accepted_cc$acc_now_delinq)
```

```{r}
table(accepted_cc$acc_open_past_24mths)
```

```{r}
head(accepted_cc)
```

## 1.6.1 Remove numerical columns that are not useful

```{r}
accepted_cc <- accepted_cc %>%
  select(-c("mths_since_recent_bc", "num_bc_sats", "num_sats", 
            "percent_bc_gt_75", "tax_liens", "total_bal_ex_mort", 
            "total_bc_limit", "disbursement_method"))
```

```{r}
table(accepted_cc$loan_status)
```

```{r}
print(paste0(names(accepted_cc), collapse = ", "))
accepted_cc
```


